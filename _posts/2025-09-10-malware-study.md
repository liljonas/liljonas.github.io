---
layout: post
title: "Process Hiding and Malware Evasion Techniques: A Windows Malware Study"
date: 2025-09-10 12:00:00 +0000
categories: [Dissertation, Malware]
tags: [Rootkits, Process Injection, Windows Security, Payload Obfuscation, Antivirus Evasion]
---

## Abstract

Rootkits are a type of malware that is highly advanced and poses significant security threats to computer systems.  
A fundamental attribute shared by all these rootkits is their ability to evade detection and maintain their illegal presence and actions concealed — not only from the operating system but also from its authorized users.  

This study provides a practical perspective on rootkit development and elucidates the typical utilization of process hiding techniques by this form of malware. We analyze real-world case studies, compare different methods with their benefits and limitations, and assess the detection and prevention techniques employed by operating systems.  

**Keywords:** `Rootkit`, `Process Injection`, `Malware`, `Windows Security`, `Payload Obfuscation`

---

## Introduction

The spread of malware is increasing on a daily basis and, due to its diverse range of manifestations, it may do significant harm to both individuals and corporate entities.  

> 💡 **Insight:** Malware was responsible for creating **30% of the data exposures** documented in the *2021 Verizon Data Breach Investigations Report* [^1].

Attackers continuously refine their strategies to outsmart defenders, instigate fear, and disrupt economic infrastructures. Innovation plays a crucial role in enabling attackers to overcome barriers and improve operations.  

The growing prevalence of cyberattacks — especially in **banking** and **critical infrastructure** — underscores the necessity of this study. **Ransomware** incidents are increasing, encrypting valuable data and demanding ransom payments. Advanced Persistent Threats (APTs) [^3], often supported by governments, also highlight the need for strong defenses.  

One famous case is the **Stuxnet worm**, the first worm designed to target Iran’s nuclear facilities [^4].  

> ⚠️ **Lesson from Stuxnet:** Even highly protected, mission-critical systems can be compromised through malware designed to manipulate hardware-level processes.

Rootkits are particularly dangerous because of their unique ability to **conceal destructive activities** from both the user and the operating system [^5].  

**Scope of this research:**  
- Build a **Windows-based lab environment** equipped with malware research tools.  
- Provide insights into the **inner workings of malware**.  
- Promote **ethical cybersecurity practices** for academia and industry.  

---

## Literature Review

The **Cyber Kill Chain** (Lockheed Martin) introduced a 7-step intrusion model, but it lacks lateral movement and privilege escalation, leading MITRE to create **ATT&CK** [^7].  

#### Malware Evolution Insights

- Automated analysis of **951 malware samples** mapped to ATT&CK shows increasing use of **fileless malware** and **inter-process communication (IPC)** [^2].  
- Even less experienced attackers now adopt **Command & Control (C2)** techniques.  

#### Hooking Evasion

Since **API hooking** is often used by security tools:  
- Malware bypasses defenses by reading DLLs before hooks are installed [^10].  
- Mini-filter drivers in Windows attempt to block this [^11].  

#### Code Reuse Attacks

Instead of injecting new code, attackers reuse existingraries:  
- *Return-intoc* attacks redirect stack return addresses toc functions [^12].  
- These bypass executable protections but are limited in flexibility.  

![Figure 3.1: Number of times each ATT&CK method was used](/assets/img/maldev/Table1.png)
_Number of times each ATT&CK method was used_

---

## Methodology

We examine various **process hiding techniques** used by rootkits and malware.

#### Process Injection Procedures

Windows API calls pass through kernel/user mode and DLLs. Attackers hook these calls to hide processes [^13].  

Steps:  
1. Intercept API call  
2. Load custom code in memory  
3. Execute original call  
4. Modify returned process list  

![Figure 4.1: Interception sites of strategies used to conceal processes](/assets/img/maldev/Figure_3.1.png)
_Interception sites of strategies used to conceal processes_

---

#### Static Patching

- Modify DLL/EXE binaries such as `ntdll.dll` or `ntoskrnl.exe` [^14].  
- Requires advanced reverse-engineering skills.  

---

#### Import Address Table (IAT) Hooking

- PE executables rely on an **Import Address Table** for external functions.  
- Malware replaces function pointers with custom handlers [^16][^17].  

![Figure 4.2: IAT-Hook setup](/assets/img/maldev/IAT.png)
_IAT-Hook setup_

**Code Injection Techniques:**  
- `CreateRemoteThread` with a custom DLL [^18].  
- `WriteProcessMemory` for direct injection.  

Detection relies on identifying abnormal addresses in the IAT [^19].  

---

#### Inline Function Patching

- Directly modifies function bytes.  
- Microsoft’s **Detours**rary replaces first 5 bytes with a jump [^20].  
- More stealthy than IAT-hooking.  

![Figure 4.3: Inline patching with detours](/assets/img/maldev/InlineFunc.png)
_Inline patching with detours_

---

#### Direct Kernel Object Manipulation (DKOM)

- Alters kernel structures like `EPROCESS` instead of hooking [^24][^25].  
- Removes process entry from linked list, making processes invisible.  

![Figure 4.4: Hidden process within EPROCESS structures](/assets/img/maldev/EPROCESS.png)
_Hidden process within EPROCESS structures_

---

#### Virtualization-Based Rootkits (VMBRs)

- Replace host OS with a hidden hypervisor.  
- Guest OS cannot detect malicious activity [^28].  

---

#### Process Hollowing

- Create suspended process → unmap memory → replace with shellcode [^29][^30][^31].  
- Exploits legitimate processes to stay hidden.  

---

## Results and Discussion

#### Experiment Setup

- **Host:** Windows 10 (64-bit, 16GB RAM, Intel i7).  
- **VMs:** Windows 10 (target), Kali Linux (attacker).  
- **Tools:** Metasploit, Windows API, System Informer [^36].  

#### Process Injection

Steps:  
0. `OpenProcess()` → get handle  
1. `VirtualAllocEx()` → allocate memory  
2. `WriteProcessMemory()` → inject shellcode  
3. `CreateRemoteThread()` → execute [^35]  

```c
// Example API calls
OpenProcess();
VirtualAllocEx();
WriteProcessMemory();
CreateRemoteThread();
```

![Figure 5.2: Generating 64-bit shellcode](/assets/img/maldev/shellcode.png)
_Generating 64-bit shellcode_
![Figure 5.3: Self-injection vs Process injection](/assets/img/maldev/selfvsprocinj.png)
_Self-injection vs Process injection_
![Figure 5.4: Process injection source code](/assets/img/maldev/procinjcode.png)
_Process injection source code_
![Figure 5.5: Injected shellcode within mspaint process](/assets/img/maldev/Untitled.png)
_Injected shellcode within mspaint process_

---

#### Antivirus Evasion (Obfuscation)

Windows Defender (WD) works in two phases:

* **Static Analysis:** checks signatures, imports, entropy.
* **Dynamic Analysis:** executes files in sandbox, monitors sockets, processes, and commands.

![Figure 5.6: End results of process injection](/assets/img/maldev/procinjrevshell.png)
_End results of process injection_
![Figure 5.7: Socket connection process](/assets/img/maldev/socket.png)
_Socket connection process_
![Figure 5.8: Detectable shell](/assets/img/maldev/detectableshell.png)
_Detectable shell_

---

###### Obfuscation Technique

* Encode API function names (e.g., `WsaStartup`) as offsets.
* Load them dynamically with `LoararyA` and `GetProcAddress`.


![Figure 5.9: Obfuscation and Original string functions](/assets/img/maldev/obfuscfunc2.png)
_Obfuscation and Original string functions_
![Figure 5.10: Offsets and obfuscated calls](/assets/img/maldev/offsets2.png)
_Offsets and obfuscated calls_
![Figure 5.11: Undetectable reverse shell](/assets/img/maldev/undetectableshell.png)
_Undetectable reverse shell_

---

#### Discussion

> ⚠️ **Key Insight:** Preventing code implants in the kernel is **insufficient**, as rootkits based on **ROP (Return-Oriented Programming)** can hide processes without injecting code \[^37]\[^38].

**Performance trade-offs:** Detection methods often consume significant resources, reducing system performance.

---

#### Future Work

* Automating payload delivery with a **C2 server**.
* Testing malware against **EDR (Endpoint Detection & Response)** systems.

---

## Conclusion

This study:

* Built a **Windows malware lab**.
* Demonstrated **process injection, obfuscation, and AV evasion**.
* Highlighted stealth strategies used by rootkits.

> 💡 **Takeaway:** Cybersecurity must evolve continuously, as attackers innovate faster than defenses.

Future research should focus on **C2 automation**, **EDR evasion**, and security for **IoT and mobile Windows systems**.

---

## References

[^1]: Verizon. *2021 Data Breach Investigations Report (DBIR)*. 2021.

[^2]: Oosthoek, K. & Doerr, C. *SoK: ATT\&CK techniques and trends in Windows malware*. SecureComm 2019.

[^4]: Farwell, J. P. & Rohozinski, R. *Stuxnet and the future of cyber war*. Survival, 53(1), 23–40, 2011.

[^7]: Strom, B. E. et al. *MITRE ATT\&CK: Design and philosophy*. MITRE Corp, 2018.

[^10]: Father, H. *Hooking Windows API*. CodeBreakers J, 2004.

[^11]: Microsoft. *Preoperation and Postoperation callback routines*. Docs, 2021.

[^12]: Designer, S. *Non-executable stack patch*. 1997.

[^13]: Ries, C. *Inside Windows Rootkits*. VigilantMinds, 2006.

[^14]: Ring, S. & Cole, E. *Taking a lesson from stealthy rootkits*. IEEE Security & Privacy, 2(4), 38–45, 2004.

[^16]: Bozağaç, C. D. *Ghostware and rootkit detection techniques for Windows*. Bilkent Univ, 2006.

[^17]: Erdélyi, G. *Hide’n’seek? Anatomy of stealth malware*. Black Hat Europe, 2004.

[^18]: Richter, J. *Load your 32 bit DLL into another process*. Microsoft Systems Journal, 1994.

[^19]: Conover, M. *Analysis of the Windows Vista security model*. Symantec, 2006.

[^20]: Brubacher, D. *Detours: Binary interception of Win32 functions*. 1999.

[^24]: Kasslin, K. et al. *Hide’n Seek revisited*. Virus Bulletin Conf, 2005.

[^25]: Russinovich, M. E. et al. *Windows Internals, Part 2*. Pearson, 2012.

[^28]: King, S. T. & Chen, P. M. *SubVirt: Implementing malware with virtual machines*. IEEE S\&P, 2006.

[^29]: MITRE ATT\&CK. *Process Injection (T1055)*.

[^30]: AutoSecTools. *Process Hollowing*. 2024.

[^31]: Hosseini, A. *Ten process injection techniques*. Elastic Blog, 2023.

[^35]: Microsoft Docs. *Win32 API Programming Reference*. 2024.

[^36]: System Informer. *Multi-purpose monitoring tool*. 2021.

[^37]: Hund, R., Holz, T. & Freiling, F. *Return-oriented rootkits*. USENIX Security, 2009.

[^38]: Vogl, S. et al. *Persistent data-only malware*. NDSS, 2014.